# 应用设计文档

## 1. 应用框架和技术选型

### 1.1 前端技术栈

**选择理由：**
- **React 18 + TypeScript**: 提供类型安全的现代化前端开发体验
- **Vite**: 快速的开发构建工具，支持热模块替换
- **Tailwind CSS**: 快速构建美观的UI界面，无需编写大量CSS
- **Axios**: 成熟的HTTP客户端，支持请求拦截和错误处理

**架构模式：**
- 组件化开发，将UI拆分为可复用的组件
- 服务层分离，API调用统一管理
- 类型定义集中管理，保证类型安全

### 1.2 后端技术栈

**选择理由：**
- **FastAPI**: 高性能的现代Python Web框架，自动生成API文档
- **Python 3.9+**: 丰富的科学计算和文本处理库生态
- **DashScope Qwen3**: 阿里云提供的大模型API，支持中文理解
- **NCBI E-Utilities**: PubMed官方提供的API接口

**架构模式：**
- RESTful API设计
- 服务层分离：LLM服务、PubMed服务、相似度计算服务、格式化服务
- 数据模型使用Pydantic进行验证

### 1.3 数据流设计

```
用户输入 → 前端组件 → API请求 → 后端服务
    ↓
LLM拆分参考文献 → 提取关键词 → PubMed查询 → 相似度计算
    ↓
返回匹配结果 → 前端展示 → 用户操作 → 更新结果
```

## 2. 代码结构设计

### 2.1 前端结构

```
frontend/
├── src/
│   ├── components/          # UI组件
│   │   ├── InputArea.tsx    # 用户输入区
│   │   ├── DataDisplayArea.tsx  # 数据展示区
│   │   └── ResultArea.tsx   # 最终结果区
│   ├── services/           # API服务
│   │   └── api.ts          # API调用封装
│   ├── types/              # TypeScript类型定义
│   │   └── index.ts
│   ├── App.tsx             # 主应用组件
│   ├── main.tsx            # 入口文件
│   └── index.css           # 全局样式
├── package.json
└── vite.config.ts
```

### 2.2 后端结构

```
backend/
├── app/
│   ├── main.py             # FastAPI应用入口
│   ├── models.py           # Pydantic数据模型
│   ├── api/                # API路由
│   │   └── routes.py      # 路由定义
│   └── services/          # 业务逻辑服务
│       ├── llm_service.py      # LLM服务（拆分、提取）
│       ├── pubmed_service.py   # PubMed API服务
│       ├── similarity_service.py  # 相似度计算服务
│       └── format_service.py   # 格式化服务
├── requirements.txt
└── .env.example
```

## 3. 拆分、查询策略

### 3.1 参考文献拆分策略

**实现方式：**
- 使用DashScope Qwen3大模型进行智能拆分
- Prompt设计要点：
  1. 明确说明支持的格式类型
  2. 要求识别每条参考文献的边界
  3. 返回结构化JSON数据

**支持的格式：**
- 通用顺序编码制：`[1] 作者. 标题. 期刊, 年份, 卷(期): 页码`
- 通用著者出版年制：`作者(年份). 标题. 期刊, 卷(期): 页码`
- 国标2015 (GB/T 7714-2015)
- APA格式
- MLA格式
- AMA格式
- NLM格式

**处理流程：**
```
输入文本 → LLM分析 → JSON数组 → 提取格式类型 → 返回结果
```

### 3.2 关键词提取策略

**提取字段：**
- title: 文章标题
- authors: 作者列表（数组）
- journal: 期刊名称
- year: 出版年份（整数）
- volume: 卷号
- issue: 期号
- pages: 页码
- pmid: PubMed ID
- doi: DOI号

**实现方式：**
- 使用LLM进行智能提取
- 只返回存在的字段，不存在的不包含在结果中
- 支持部分信息缺失的情况

### 3.3 PubMed查询策略

**优先级顺序：**

1. **DOI优先检索**（最高优先级）
   - 如果存在DOI，直接使用DOI检索
   - DOI匹配成功，直接返回该文献（100%匹配）

2. **标题检索**
   - 使用标题进行检索
   - 如果结果唯一，返回该文献

3. **标题 + 第一作者**
   - 如果标题检索结果不唯一
   - 添加第一作者进行组合检索

4. **标题 + 期刊 + 出版年**
   - 进一步缩小检索范围
   - 提高检索精度

**查询实现：**
```python
# 伪代码
if doi:
    pmid = search_by_doi(doi)
    if pmid:
        return fetch_article(pmid)

if title:
    pmids = search_by_title(title)
    if len(pmids) == 1:
        return fetch_article(pmids[0])
    
    if authors:
        pmids = search_by_title_and_author(title, authors[0])
    
    if journal and year:
        pmids = search_by_title_journal_year(title, journal, year)
```

### 3.4 相似度计算策略

**权重配置：**
- DOI: 30%（最高权重，完全匹配直接返回）
- PMID: 25%
- 标题: 20%
- 作者: 15%
- 期刊: 5%
- 年份: 3%
- 卷号: 1%
- 期号: 1%
- 页码: 0%（不参与相似度计算）

**计算方式：**
1. **完全匹配检查**：DOI完全匹配 → 返回100%相似度
2. **字段相似度计算**：
   - 文本字段使用SequenceMatcher计算相似度
   - 作者列表计算第一作者匹配度和整体匹配度
   - 数值字段（年份、卷期）进行精确匹配
3. **加权平均**：各字段相似度 × 权重后求和

**阈值设置：**
- 相似度 ≥ 100%：返回唯一结果
- 相似度 ≥ 50%：返回排序后的列表
- 相似度 < 50%：标记为"未检索到"

**差异标注：**
- 对比原始关键词和匹配文献的关键词
- 标记不一致的字段（标红显示）
- 显示原始值和匹配值

## 4. 用户交互设计

### 4.1 界面布局

**左侧区域（上下布局）：**
- **用户输入区**（上方）
  - 文本输入框
  - 提交按钮
  - 加载状态提示

- **最终结果区**（下方）
  - 格式化后的参考文献列表
  - 格式选择下拉框
  - 复制/导出按钮
  - 可编辑文本区域

**右侧区域：**
- **数据展示区**（全高）
  - 滚动显示所有参考文献
  - 每条显示：原始文本、提取关键词、匹配结果
  - 操作按钮：补全、替换、删除

### 4.2 交互流程

1. **输入阶段**
   - 用户在输入区粘贴参考文献列表
   - 点击"提交"按钮

2. **处理阶段**
   - 显示加载状态
   - 后端拆分参考文献
   - 提取关键词
   - 查询PubMed
   - 计算相似度

3. **展示阶段**
   - 右侧显示处理结果
   - 每条参考文献显示匹配的文献列表
   - 标红显示差异字段

4. **操作阶段**
   - **补全**：使用匹配文献的信息补全原始参考文献
   - **替换**：用匹配文献完全替换原始参考文献
   - **删除**：删除不需要的参考文献

5. **结果阶段**
   - 左侧最终结果区实时更新
   - 用户可以选择格式导出
   - 支持复制到剪贴板

## 5. 错误处理

### 5.1 前端错误处理
- API请求失败时显示错误提示
- 网络错误时提示用户检查网络连接
- 数据格式错误时提示用户检查输入

### 5.2 后端错误处理
- LLM API调用失败：返回空结果，记录错误日志
- PubMed API调用失败：返回空结果，提示用户稍后重试
- 数据验证失败：返回400错误，提示具体错误信息

## 6. 性能优化

### 6.1 前端优化
- 使用React.memo减少不必要的重渲染
- 虚拟滚动（如果参考文献数量很大）
- 防抖处理用户输入

### 6.2 后端优化
- 异步处理PubMed API请求
- 批量处理多条参考文献
- 缓存常用查询结果（可选）

## 7. 扩展性考虑

### 7.1 格式支持扩展
- 新增格式类型只需在format_service中添加格式化方法
- LLM Prompt可以动态更新支持新格式

### 7.2 API扩展
- 可以添加更多文献数据库支持（如Crossref、Google Scholar）
- 可以添加更多相似度计算算法

### 7.3 功能扩展
- 支持批量导入/导出
- 支持参考文献去重
- 支持参考文献格式统一转换

