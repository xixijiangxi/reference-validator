# 参考文献检索策略设计建议

## 目标
找到和原始参考文献**最可能是同一篇**的文献，平衡**精确度**和**召回率**。

---

## 信息可靠性分析

### 字段可靠性排序（从高到低）

1. **DOI/PMID** ⭐⭐⭐⭐⭐
   - 唯一标识符，最可靠
   - 如果存在，应该优先使用

2. **标题 + 第一作者 + 期刊 + 年份** ⭐⭐⭐⭐⭐
   - 四个字段组合，几乎唯一确定一篇文章

3. **标题 + 期刊 + 年份** ⭐⭐⭐⭐
   - 三个字段组合，可靠性高

4. **标题 + 第一作者** ⭐⭐⭐
   - 两个字段组合，中等可靠性

5. **标题** ⭐⭐
   - 单一字段，可能有重复

---

## 当前策略的问题

1. **过于依赖完全匹配**
   - 标题完全匹配可能因为格式差异失败
   - 作者格式差异（"Li, X" vs "Li, Xinyi"）
   - 期刊格式差异（"Anal Chem" vs "Analytical chemistry"）

2. **缺少相似度评估**
   - 找到多篇文章时，没有排序机制
   - 无法识别"最可能"的匹配

3. **缺少格式容差处理**
   - 没有处理作者缩写vs全名
   - 没有处理期刊缩写vs全名
   - 没有年份容差（±1年）

---

## 改进的检索策略设计

### 策略1：分层检索（从精确到模糊）

```
优先级1: DOI/PMID 直接搜索
  ↓ 如果找到，直接返回（唯一标识符）

优先级2: 标题完全匹配 + 多字段组合
  - 2a: 标题 + 第一作者 + 期刊 + 年份（精确）
  - 2b: 标题 + 期刊 + 年份（精确）
  - 2c: 标题 + 第一作者（精确）
  - 2d: 标题（精确）
  ↓ 如果找到唯一结果，返回

优先级3: 标题模糊匹配 + 多字段组合
  - 3a: 标题关键词 + 第一作者 + 期刊 + 年份（模糊）
  - 3b: 标题关键词 + 期刊 + 年份（模糊）
  - 3c: 标题关键词 + 第一作者（模糊）
  - 3d: 标题关键词（模糊）

优先级4: 相似度排序和筛选
  - 计算每篇文章与原始参考文献的相似度
  - 按相似度排序
  - 返回相似度最高的1-3篇文章
```

### 策略2：格式容差处理

#### 作者格式处理
- **输入**: "Li, X" 或 "Li X"
- **搜索策略**:
  1. 精确匹配: `"Li, X"[Author]`
  2. 模糊匹配: `Li[Author] AND X[Author]`（允许全名匹配）
  3. 姓氏匹配: `Li[Author]`（如果其他字段匹配度高）

#### 期刊格式处理
- **输入**: "Anal Chem" 或 "Analytical chemistry"
- **搜索策略**:
  1. 精确匹配: `"Anal Chem"[Journal]`
  2. 尝试全名: `"Analytical chemistry"[Journal]`
  3. 关键词匹配: `Anal[Journal] AND Chem[Journal]`

#### 年份容差
- **输入**: 2025
- **搜索策略**:
  1. 精确匹配: `2025[Publication Date]`
  2. 容差匹配: `(2024 OR 2025 OR 2026)[Publication Date]`（±1年）

### 策略3：相似度评分机制

对每篇找到的文章计算相似度分数：

```python
相似度 = (
    标题相似度 × 0.4 +
    作者相似度 × 0.3 +
    期刊相似度 × 0.15 +
    年份匹配 × 0.1 +
    其他字段匹配 × 0.05
)
```

**评分规则**:
- **标题相似度** (0-1):
  - 完全匹配: 1.0
  - 编辑距离 < 5%: 0.9
  - 关键词重叠 > 80%: 0.8
  - 关键词重叠 > 60%: 0.6
  - 其他: 0.3

- **作者相似度** (0-1):
  - 第一作者完全匹配: 1.0
  - 第一作者姓氏匹配: 0.7
  - 作者列表重叠 > 50%: 0.8
  - 其他: 0.3

- **期刊相似度** (0-1):
  - 完全匹配: 1.0
  - 缩写/全名匹配: 0.9
  - 关键词匹配: 0.6

- **年份匹配** (0-1):
  - 完全匹配: 1.0
  - ±1年: 0.8
  - ±2年: 0.5

---

## 具体实现建议

### 1. 添加PMID直接搜索

```python
# 优先级0: PMID直接搜索（如果提取到了）
if keywords.get("pmid"):
    pmid = keywords["pmid"]
    article = await self.fetch_article_details(pmid)
    if article:
        return [article]  # 直接返回，最可靠
```

### 2. 改进标题搜索策略

```python
# 优先级2: 标题搜索（多策略）
if keywords.get("title"):
    # 2a: 标题完全匹配 + 多字段组合
    strategies = [
        (title, author, journal, year),  # 最精确
        (title, None, journal, year),    # 次精确
        (title, author, None, None),      # 中等
        (title, None, None, None),        # 基础
    ]
    
    for title, author, journal, year in strategies:
        pmids = await search_by_title(title, author, journal, year, exact_match=True)
        if pmids:
            articles = await fetch_articles(pmids)
            # 计算相似度并排序
            scored_articles = score_articles(articles, keywords)
            if scored_articles[0].score > 0.9:  # 高相似度
                return [scored_articles[0]]
    
    # 2b: 如果完全匹配失败，尝试模糊匹配
    # ... 类似逻辑，但使用 exact_match=False
```

### 3. 添加相似度评分函数

```python
def calculate_similarity(article: Dict, keywords: Dict) -> float:
    """计算文章与关键词的相似度"""
    score = 0.0
    
    # 标题相似度 (40%)
    title_sim = title_similarity(article.get("title"), keywords.get("title"))
    score += title_sim * 0.4
    
    # 作者相似度 (30%)
    author_sim = author_similarity(article.get("authors"), keywords.get("authors"))
    score += author_sim * 0.3
    
    # 期刊相似度 (15%)
    journal_sim = journal_similarity(article.get("journal"), keywords.get("journal"))
    score += journal_sim * 0.15
    
    # 年份匹配 (10%)
    year_sim = year_similarity(article.get("year"), keywords.get("year"))
    score += year_sim * 0.1
    
    # 其他字段 (5%)
    other_sim = other_fields_similarity(article, keywords)
    score += other_sim * 0.05
    
    return score
```

### 4. 处理格式差异

```python
def normalize_author(author: str) -> str:
    """标准化作者格式"""
    # "Li, X" -> "Li X"
    # "Li, Xinyi" -> "Li Xinyi"
    # 提取姓氏和名字首字母
    pass

def normalize_journal(journal: str) -> str:
    """标准化期刊格式"""
    # "Anal Chem" -> "Analytical chemistry"
    # 使用期刊缩写映射表
    pass
```

---

## 推荐的最终策略

### 检索流程

1. **唯一标识符优先**
   - DOI → PMID → 直接获取文章

2. **精确匹配 + 多字段组合**
   - 标题+作者+期刊+年份
   - 标题+期刊+年份
   - 标题+作者
   - 标题

3. **模糊匹配 + 多字段组合**
   - 如果精确匹配失败，使用关键词匹配

4. **相似度排序**
   - 计算所有找到文章的相似度
   - 返回相似度最高的1-3篇

5. **格式容差**
   - 作者：支持缩写/全名
   - 期刊：支持缩写/全名
   - 年份：±1年容差

### 返回策略

- **高置信度** (相似度 > 0.9): 返回1篇
- **中等置信度** (相似度 0.7-0.9): 返回1-2篇
- **低置信度** (相似度 < 0.7): 返回最多3篇，让用户选择

---

## 总结

**核心原则**:
1. ✅ 从最精确到最模糊
2. ✅ 多字段组合提高可靠性
3. ✅ 格式容差处理
4. ✅ 相似度评分排序
5. ✅ 优先返回高置信度结果

这样的设计能够在保证精确度的同时，提高召回率，找到"最可能是同一篇"的文献。

