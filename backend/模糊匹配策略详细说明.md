# 模糊匹配策略详细说明

## 概述

模糊匹配是检索策略中的**优先级3**，当精确匹配（优先级2）未找到结果时才会执行。模糊匹配通过提取标题关键词，结合其他字段进行搜索，能够处理格式差异、拼写错误等情况。

---

## 触发条件

### 前置条件

1. ✅ **精确匹配失败**: 优先级2的所有策略都未找到结果（`len(results) == 0`）
2. ✅ **必须有标题**: 关键词中包含 `title` 字段
3. ✅ **关键词数量**: 提取的关键词数量 >= 5个

### 代码逻辑

```python
# 优先级3: 模糊匹配 + 多字段组合（如果精确匹配未找到高置信度结果）
if title and len(results) == 0:
    logger.info(f"[优先级3] 精确匹配未找到结果，尝试模糊匹配")
    # 执行模糊匹配...
```

---

## 关键词提取过程

### 步骤1: 分词

```python
title_words = title.split()
# 示例: "Machine Learning in Medical Research: A Comprehensive Review"
# 结果: ["Machine", "Learning", "in", "Medical", "Research:", "A", "Comprehensive", "Review"]
```

### 步骤2: 停用词过滤

**停用词列表**:
```python
stop_words = {
    'the', 'a', 'an', 'and', 'or', 'for', 'of', 
    'in', 'on', 'at', 'to', 'by', 'with', 
    'is', 'are', 'was', 'were'
}
```

**过滤规则**:
- 去除停用词（如 "the", "a", "in", "of" 等）
- 去除长度 <= 2 的词（如 "a", "an", "in", "on" 等）

**代码**:
```python
keywords_list = [w for w in title_words 
                 if w.lower() not in stop_words and len(w) > 2]
```

**示例**:
```
输入: "Machine Learning in Medical Research: A Comprehensive Review"
分词: ["Machine", "Learning", "in", "Medical", "Research:", "A", "Comprehensive", "Review"]
过滤: ["Machine", "Learning", "Medical", "Research:", "Comprehensive", "Review"]
```

### 步骤3: 关键词数量限制

**规则**:
- 如果关键词数量 >= 5，继续执行模糊匹配
- 如果关键词数量 < 5，跳过模糊匹配

**代码**:
```python
if len(keywords_list) >= 5:
    num_keywords = min(10, len(keywords_list))  # 最多使用10个关键词
    key_title = " ".join(keywords_list[:num_keywords])
```

**示例**:
```
关键词列表: ["Machine", "Learning", "Medical", "Research", "Comprehensive", "Review"]
数量: 6 >= 5 ✅
取前10个: ["Machine", "Learning", "Medical", "Research", "Comprehensive", "Review"]
组合: "Machine Learning Medical Research Comprehensive Review"
```

---

## 模糊匹配策略列表

模糊匹配策略按**可靠性从高到低**的顺序执行，找到结果后立即停止。

### 策略1: 关键词 + 第一作者 + 期刊 + 年份

**策略名称**: `"关键词+作者+期刊+年份"`

**查询格式**:
```
(关键词1 AND 关键词2 AND ...)[Title] AND "第一作者"[Author] AND "期刊"[Journal] AND 年份[Publication Date]
```

**实际查询示例**:
```
(Machine AND Learning AND Medical AND Research AND Comprehensive AND Review)[Title] 
AND "Smith"[Author] 
AND "Nature Medicine"[Journal] 
AND 2023[Publication Date]
```

**触发条件**:
- ✅ 必须有第一作者 (`first_author`)
- ✅ 必须有期刊 (`journal`)
- ✅ 必须有年份 (`year`)

**代码检查**:
```python
if strategy_name == "关键词+作者+期刊+年份" and not (a and j and y):
    continue  # 跳过此策略
```

**设计原因**:
- **最高精确度**: 四个字段组合（关键词+作者+期刊+年份）几乎唯一确定一篇文章
- **多维度约束**: 即使关键词匹配不精确，通过作者、期刊、年份可以缩小范围

**适用场景**:
- 标题格式与PubMed中的格式有差异
- 标题中有拼写错误或缩写
- 但作者、期刊、年份信息完整

---

### 策略2: 关键词 + 期刊 + 年份

**策略名称**: `"关键词+期刊+年份"`

**查询格式**:
```
(关键词1 AND 关键词2 AND ...)[Title] AND "期刊"[Journal] AND 年份[Publication Date]
```

**实际查询示例**:
```
(Machine AND Learning AND Medical AND Research AND Comprehensive AND Review)[Title] 
AND "Nature Medicine"[Journal] 
AND 2023[Publication Date]
```

**触发条件**:
- ✅ 必须有期刊 (`journal`)
- ✅ 必须有年份 (`year`)
- ❌ 可以没有作者

**代码检查**:
```python
if strategy_name == "关键词+期刊+年份" and not (j and y):
    continue  # 跳过此策略
```

**设计原因**:
- **高精确度**: 三个字段组合（关键词+期刊+年份）通常能唯一确定文章
- **容错性**: 如果作者信息不完整，仍能准确匹配

**适用场景**:
- 缺少作者信息
- 但期刊和年份信息完整
- 标题格式有差异

---

### 策略3: 关键词 + 第一作者

**策略名称**: `"关键词+作者"`

**查询格式**:
```
(关键词1 AND 关键词2 AND ...)[Title] AND "第一作者"[Author]
```

**实际查询示例**:
```
(Machine AND Learning AND Medical AND Research AND Comprehensive AND Review)[Title] 
AND "Smith"[Author]
```

**触发条件**:
- ✅ 必须有第一作者 (`first_author`)
- ❌ 可以没有期刊和年份

**代码检查**:
```python
if strategy_name == "关键词+作者" and not a:
    continue  # 跳过此策略
```

**设计原因**:
- **中等精确度**: 两个字段组合（关键词+作者），适合信息不完整的情况
- **平衡**: 在精确度和召回率之间取得平衡

**适用场景**:
- 缺少期刊或年份信息
- 但作者信息完整
- 标题格式有差异

---

### 策略4: 关键词（单独）

**策略名称**: `"关键词"`

**查询格式**:
```
(关键词1 AND 关键词2 AND ...)[Title]
```

**实际查询示例**:
```
(Machine AND Learning AND Medical AND Research AND Comprehensive AND Review)[Title]
```

**触发条件**:
- ❌ 可以没有作者、期刊、年份
- ✅ 只要有标题关键词即可

**设计原因**:
- **基础策略**: 当其他信息都缺失时的最后选择
- **召回率高**: 能找到所有包含这些关键词的文章

**适用场景**:
- 只有标题信息
- 其他字段都缺失
- 标题格式有差异

---

## 执行流程

### 完整流程图

```
精确匹配失败 (len(results) == 0)
    ↓
提取标题关键词
    ├─ 分词
    ├─ 过滤停用词
    └─ 限制数量 (最多10个)
    ↓
检查关键词数量 >= 5?
    ├─ 是 → 继续
    └─ 否 → 跳过模糊匹配
    ↓
[策略1] 关键词+作者+期刊+年份
    ├─ 检查条件: 有作者、期刊、年份?
    ├─ 是 → 执行搜索
    ├─ 找到结果? → 是 → 停止，返回结果
    └─ 否 → 继续下一个策略
    ↓
[策略2] 关键词+期刊+年份
    ├─ 检查条件: 有期刊、年份?
    ├─ 是 → 执行搜索
    ├─ 找到结果? → 是 → 停止，返回结果
    └─ 否 → 继续下一个策略
    ↓
[策略3] 关键词+作者
    ├─ 检查条件: 有作者?
    ├─ 是 → 执行搜索
    ├─ 找到结果? → 是 → 停止，返回结果
    └─ 否 → 继续下一个策略
    ↓
[策略4] 关键词（单独）
    ├─ 执行搜索
    └─ 返回结果（无论是否找到）
```

### 代码实现

```python
# 模糊匹配策略（按可靠性从高到低）
fuzzy_strategies = [
    ("关键词+作者+期刊+年份", key_title, first_author, journal, year),
    ("关键词+期刊+年份", key_title, None, journal, year),
    ("关键词+作者", key_title, first_author, None, None),
    ("关键词", key_title, None, None, None),
]

for strategy_name, t, a, j, y in fuzzy_strategies:
    # 检查策略是否有效
    if strategy_name == "关键词+作者+期刊+年份" and not (a and j and y):
        continue
    if strategy_name == "关键词+期刊+年份" and not (j and y):
        continue
    if strategy_name == "关键词+作者" and not a:
        continue
    
    # 执行搜索
    logger.info(f"  策略: {strategy_name}")
    pmids = await self.search_by_title(t, author=a, journal=j, year=y, exact_match=False)
    logger.info(f"    找到 {len(pmids)} 个 PMID")
    
    # 获取文章详情
    for pmid in pmids:
        if pmid not in seen_pmids:
            article = await self.fetch_article_details(pmid)
            if article:
                results.append(article)
                seen_pmids.add(pmid)
    
    # 如果找到结果，停止执行后续策略
    if results:
        break
```

---

## 精确匹配 vs 模糊匹配

### 精确匹配（优先级2）

**查询方式**:
```python
exact_match=True
# 查询: "Machine Learning in Medical Research"[Title]
```

**特点**:
- 使用引号包裹整个标题
- 要求标题完全匹配（忽略大小写）
- 如果标题格式有差异，可能找不到

### 模糊匹配（优先级3）

**查询方式**:
```python
exact_match=False
# 查询: (Machine AND Learning AND Medical AND Research)[Title]
```

**特点**:
- 不使用引号
- 使用关键词 AND 连接
- 只要标题中包含这些关键词即可匹配
- 可以处理格式差异、拼写错误等

**代码实现**:
```python
if exact_match:
    query_parts = [f'"{title_clean}"[Title]']  # 精确匹配：使用引号
else:
    # 部分匹配：使用关键词，用 AND 连接
    title_words = title_clean.split()
    query_parts = [f'({" AND ".join(title_words)})[Title]']  # 模糊匹配：AND连接
```

---

## 实际应用示例

### 示例1: 完整信息 + 标题格式差异

**输入**:
```json
{
  "title": "Machine Learning Medical Research Comprehensive Review",
  "authors": ["Smith J"],
  "journal": "Nature Medicine",
  "year": 2023
}
```

**PubMed中的实际标题**: "Machine Learning in Medical Research: A Comprehensive Review"

**流程**:
1. **精确匹配失败**: `"Machine Learning Medical Research Comprehensive Review"[Title]` 未找到
2. **提取关键词**: ["Machine", "Learning", "Medical", "Research", "Comprehensive", "Review"]
3. **策略1执行**: 
   ```
   (Machine AND Learning AND Medical AND Research AND Comprehensive AND Review)[Title] 
   AND "Smith"[Author] 
   AND "Nature Medicine"[Journal] 
   AND 2023[Publication Date]
   ```
4. **找到结果**: ✅ 找到文章
5. **停止**: 不再执行后续策略

---

### 示例2: 部分信息 + 标题格式差异

**输入**:
```json
{
  "title": "Machine Learning Medical Research",
  "journal": "Nature Medicine",
  "year": 2023
}
```

**流程**:
1. **精确匹配失败**: 未找到
2. **提取关键词**: ["Machine", "Learning", "Medical", "Research"]
3. **策略1跳过**: 缺少作者
4. **策略2执行**: 
   ```
   (Machine AND Learning AND Medical AND Research)[Title] 
   AND "Nature Medicine"[Journal] 
   AND 2023[Publication Date]
   ```
5. **找到结果**: ✅ 找到文章
6. **停止**: 不再执行后续策略

---

### 示例3: 只有标题

**输入**:
```json
{
  "title": "Machine Learning Medical Research"
}
```

**流程**:
1. **精确匹配失败**: 未找到
2. **提取关键词**: ["Machine", "Learning", "Medical", "Research"]
3. **策略1跳过**: 缺少作者、期刊、年份
4. **策略2跳过**: 缺少期刊、年份
5. **策略3跳过**: 缺少作者
6. **策略4执行**: 
   ```
   (Machine AND Learning AND Medical AND Research)[Title]
   ```
7. **找到结果**: ✅ 可能找到多篇文章
8. **继续**: 进入优先级4（相似度排序）

---

## 关键设计点

### 1. 关键词提取的智能性

**为什么过滤停用词？**
- 停用词（如 "the", "a", "in"）没有实际意义
- 过滤后保留有意义的词汇，提高匹配精确度
- 减少查询复杂度

**为什么限制关键词数量？**
- 避免查询过长
- PubMed对查询长度有限制
- 前10个关键词通常包含核心信息

### 2. 策略顺序的重要性

**为什么按可靠性排序？**
- 高可靠性策略优先执行，找到结果后立即停止
- 避免不必要的低可靠性搜索
- 提高检索效率

**为什么找到结果就停止？**
- 避免重复搜索
- 减少API调用次数
- 提高响应速度

### 3. 条件检查机制

**为什么检查字段是否存在？**
- 避免无效的API调用
- 如果缺少必要字段，策略无法执行
- 自动跳过无效策略，提高效率

---

## 性能优化

### 1. 提前停止机制

```python
if results:
    break  # 找到结果后立即停止
```

**效果**: 避免执行不必要的后续策略

### 2. 去重机制

```python
seen_pmids = set()
for pmid in pmids:
    if pmid not in seen_pmids:
        # 处理文章
        seen_pmids.add(pmid)
```

**效果**: 避免重复获取同一篇文章

### 3. 条件检查

```python
if strategy_name == "关键词+作者+期刊+年份" and not (a and j and y):
    continue  # 跳过无效策略
```

**效果**: 避免无效的API调用

---

## 总结

### 模糊匹配策略特点

1. **分层递进**: 从多字段组合到单字段，逐步放宽约束
2. **智能提取**: 自动提取关键词，过滤停用词
3. **条件检查**: 自动跳过无效策略
4. **提前停止**: 找到结果后立即停止
5. **去重处理**: 避免重复获取文章

### 适用场景

- ✅ 标题格式与PubMed中的格式有差异
- ✅ 标题中有拼写错误或缩写
- ✅ 标题不完整（缺少部分词汇）
- ✅ 需要提高召回率

### 设计优势

- **高召回率**: 通过关键词匹配，能找到更多相关文章
- **格式容差**: 能处理格式差异、大小写差异等
- **效率优化**: 按可靠性排序，找到结果后立即停止
- **智能筛选**: 自动跳过无效策略，减少不必要的API调用

