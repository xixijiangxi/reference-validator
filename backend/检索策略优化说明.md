# 检索策略优化说明

## 优化概述

已成功优化 `pubmed_service.py` 中的 `search_articles` 方法，实现了更智能、更可靠的检索策略。

---

## 主要改进

### 1. ✅ 添加PMID直接搜索（优先级0）

**改进前**: 只有DOI搜索  
**改进后**: 添加了PMID直接搜索，如果提取到PMID，直接获取文章，跳过所有搜索步骤

```python
# 优先级0: PMID直接搜索（最可靠）
if keywords.get("pmid"):
    article = await self.fetch_article_details(pmid)
    if article:
        return [article]  # 直接返回
```

**优势**: 
- 最快速、最可靠
- 避免不必要的搜索步骤

---

### 2. ✅ 多字段组合策略（优先级2）

**改进前**: 固定顺序的单一字段搜索  
**改进后**: 按可靠性从高到低尝试多种字段组合

**精确匹配策略**（按可靠性排序）:
1. 标题 + 第一作者 + 期刊 + 年份（最高可靠性）
2. 标题 + 期刊 + 年份
3. 标题 + 第一作者
4. 标题（基础）

**优势**:
- 优先使用多字段组合，提高精确度
- 自动跳过无效策略（缺少必要字段）
- 找到高置信度结果时提前返回

---

### 3. ✅ 实时相似度评估

**改进前**: 搜索完成后才计算相似度  
**改进后**: 在搜索过程中实时计算相似度

**功能**:
- 每找到一篇文章，立即计算相似度
- 如果相似度>0.9，立即返回（高置信度）
- 如果结果唯一，直接返回

**优势**:
- 减少不必要的搜索步骤
- 更快返回高置信度结果

---

### 4. ✅ 模糊匹配策略（优先级3）

**改进前**: 简单的关键词搜索  
**改进后**: 结构化的模糊匹配策略

**模糊匹配策略**（按可靠性排序）:
1. 关键词 + 第一作者 + 期刊 + 年份
2. 关键词 + 期刊 + 年份
3. 关键词 + 第一作者
4. 关键词（基础）

**优势**:
- 只在精确匹配失败时使用
- 保持多字段组合的优势
- 提高召回率

---

### 5. ✅ 智能返回策略（优先级4）

**改进前**: 固定返回所有结果  
**改进后**: 根据相似度智能返回

**返回策略**:
- **高置信度** (相似度 > 0.9): 返回1篇最佳匹配
- **中等置信度** (相似度 0.7-0.9): 返回前2篇
- **低置信度** (相似度 < 0.7): 返回前3篇

**优势**:
- 减少不相关结果
- 提高用户体验
- 自动选择最可能的匹配

---

### 6. ✅ 长标题处理优化

**改进前**: 简单的截断处理  
**改进后**: 智能的长标题处理

**处理逻辑**:
- 如果标题>15个词，使用前15个词
- 同时尝试带期刊和不带期刊的搜索
- 合并结果，去重

---

## 检索流程

```
优先级0: PMID直接搜索
  ↓ 如果找到，直接返回

优先级1: DOI搜索
  ↓ 如果找到，直接返回

优先级2: 精确匹配 + 多字段组合
  - 2a: 标题+作者+期刊+年份
  - 2b: 标题+期刊+年份
  - 2c: 标题+作者
  - 2d: 标题
  ↓ 实时计算相似度
  ↓ 如果相似度>0.9，返回最佳匹配
  ↓ 如果结果唯一，直接返回

优先级2b: 长标题处理
  - 使用前15个词
  - 尝试带/不带期刊

优先级3: 模糊匹配 + 多字段组合
  - 3a: 关键词+作者+期刊+年份
  - 3b: 关键词+期刊+年份
  - 3c: 关键词+作者
  - 3d: 关键词

优先级4: 相似度排序和智能返回
  - 计算所有结果的相似度
  - 按相似度排序
  - 根据置信度返回1-3篇
```

---

## 性能优化

1. **提前返回**: 找到高置信度结果时立即返回
2. **去重**: 使用 `seen_pmids` 避免重复获取
3. **延迟导入**: 相似度服务延迟导入，避免循环依赖
4. **智能跳过**: 自动跳过无效策略

---

## 使用示例

### 场景1: 有PMID
```
输入: {pmid: "39700052", ...}
→ 优先级0: 直接获取文章
→ 返回: 1篇文章（最快）
```

### 场景2: 完整信息
```
输入: {title: "...", authors: [...], journal: "...", year: 2025}
→ 优先级2a: 标题+作者+期刊+年份（精确匹配）
→ 找到结果，计算相似度=0.95
→ 返回: 1篇最佳匹配（高置信度）
```

### 场景3: 部分信息
```
输入: {title: "...", journal: "...", year: 2025}
→ 优先级2b: 标题+期刊+年份（精确匹配）
→ 找到3篇结果，计算相似度=[0.85, 0.72, 0.65]
→ 返回: 前2篇（中等置信度）
```

### 场景4: 格式差异
```
输入: {title: "...", authors: ["Li, X"], ...}
→ 优先级2: 精确匹配失败
→ 优先级3: 模糊匹配（关键词+作者）
→ 找到结果，计算相似度=0.78
→ 返回: 前2篇（中等置信度）
```

---

## 对比总结

| 方面 | 优化前 | 优化后 |
|------|--------|--------|
| 唯一标识符 | 只有DOI | DOI + PMID |
| 搜索策略 | 固定顺序 | 多字段组合，按可靠性排序 |
| 相似度计算 | 搜索后计算 | 实时计算，提前返回 |
| 返回策略 | 固定数量 | 根据置信度智能返回 |
| 长标题处理 | 简单截断 | 智能处理，多策略尝试 |
| 模糊匹配 | 单一策略 | 多字段组合策略 |

---

## 预期效果

1. **精确度提升**: 多字段组合策略提高匹配准确度
2. **召回率提升**: 模糊匹配策略提高找到文章的概率
3. **速度提升**: 提前返回机制减少不必要的搜索
4. **用户体验提升**: 智能返回策略减少不相关结果

---

## 测试建议

建议测试以下场景：
1. ✅ 有PMID的情况（应该最快）
2. ✅ 完整信息的情况（应该找到高置信度匹配）
3. ✅ 部分信息的情况（应该找到中等置信度匹配）
4. ✅ 格式差异的情况（应该通过模糊匹配找到）
5. ✅ 长标题的情况（应该正确处理）

---

## 总结

优化后的检索策略更加智能、可靠，能够在保证精确度的同时提高召回率，并智能返回最可能的匹配结果。

